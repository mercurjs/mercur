import fs from "fs/promises";
import path from "path";
import { DIST_DIR } from "./constants";
import { ensureDir } from "./fs";
import { getRoutes, type RouteInfo } from "./routes";

export { getRoutes, type RouteInfo } from "./routes";
export { recursiveReadDir, pathExists, ensureDir } from "./fs";
export { normalizeApiPath, normalizePathSep } from "./path";
export { DIST_DIR, ROUTE_FILE_PATTERN } from "./constants";

function generateRouteTypeName(route: string): string {
    // Convert "/admin/custom" to "AdminCustomRoute"
    return route
        .split("/")
        .filter(Boolean)
        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
        .join("") + "Route";
}

function generateImportPath(filePath: string): string {
    return `../../src/api/${filePath.replace(/\.ts$/, "")}`;
}

export function generateRouteTypesFile(routes: RouteInfo[]): string {
    const typeImports: string[] = [];
    const routeEntries: string[] = [];

    for (const route of routes) {
        const typeName = generateRouteTypeName(route.route);
        const importPath = generateImportPath(route.filePath);

        typeImports.push(`type ${typeName} = typeof import("${importPath}");`);

        routeEntries.push(`    "${route.route}": ${typeName};`);
    }

    const typeImportsContent = typeImports.join("\n");
    const routeEntriesContent = routeEntries.join("\n");

    return `// This file is generated automatically by Mercur CLI
// Do not edit this file manually

${typeImportsContent}

export type Router = {
${routeEntriesContent}
};
`;
}

export async function writeRouteTypes(rootDir: string) {
    const entryFilePath = path.join(rootDir, DIST_DIR, "routes.ts");
    const apiDir = path.join(rootDir, "src", "api");
    const entryDir = path.dirname(entryFilePath);

    await ensureDir(entryDir);

    const routes = await getRoutes(apiDir);
    const routeTypes = generateRouteTypesFile(routes);

    await fs.writeFile(entryFilePath, routeTypes, "utf-8");
}
