import fs from "fs/promises";
import path from "path";
import { type CompilerOptions } from "typescript";
import { DIST_DIR } from "./constants";
import { ensureDir } from "./fs";
import { getRoutes } from "./routes";
import type { RouteInfo } from "@mercurjs/types";

export { getRoutes } from "./routes";
export { recursiveReadDir, pathExists, ensureDir } from "./fs";
export { normalizeApiPath, normalizePathSep } from "./path";
export { DIST_DIR, ROUTE_FILE_PATTERN } from "./constants";

export function generateRouteTypesFile(routes: RouteInfo[]): string {
    const queries: string[] = [];
    const mutations: string[] = [];
    const deletes: string[] = [];

    for (const route of routes) {
        const routeKey = `"${route.route}"`;
        for (const handler of route.handlers) {
            const input = handler.input || "Record<string, any>";
            const output = handler.output || "unknown";
            const routeDef = `{ input: ${input}; output: ${output} }`;

            switch (handler.method) {
                case "GET":
                    queries.push(`        ${routeKey}: ${routeDef};`);
                    break;
                case "POST":
                    mutations.push(`        ${routeKey}: ${routeDef};`);
                    break;
                case "DELETE":
                    deletes.push(`        ${routeKey}: ${routeDef};`);
                    break;
            }
        }
    }

    const queriesContent = queries.sort().join("\n");
    const mutationsContent = mutations.sort().join("\n");
    const deletesContent = deletes.sort().join("\n");

    return `// This file is generated automatically by Mercur CLI
// Do not edit this file manually

export type Router = {
    queries: {
${queriesContent}
    };
    mutations: {
${mutationsContent}
    };
    deletes: {
${deletesContent}
    };
};
`;
}

export async function writeRouteTypes(rootDir: string, tsConfig: CompilerOptions) {
    const entryFilePath = path.join(rootDir, DIST_DIR, "routes.d.ts");
    const apiDir = path.join(rootDir, "src", "api");
    const entryDir = path.dirname(entryFilePath);

    await ensureDir(entryDir);

    const routes = await getRoutes(apiDir, tsConfig);
    const routeTypes = generateRouteTypesFile(routes);

    await fs.writeFile(entryFilePath, routeTypes, "utf-8");
}
