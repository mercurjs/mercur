import fs from "fs/promises";
import path from "path";
import { DIST_DIR, defaultMedusaRoutes } from "./constants";
import { ensureDir } from "./fs";
import { getRoutes, type RouteInfo } from "./routes";

export { getRoutes, type RouteInfo } from "./routes";
export { recursiveReadDir, pathExists, ensureDir } from "./fs";
export { normalizeApiPath, normalizePathSep } from "./path";
export { DIST_DIR, ROUTE_FILE_PATTERN } from "./constants";

function generateImportPath(filePath: string): string {
    return `../../src/api/${filePath.replace(/\.ts$/, "")}`;
}

export function generateRouteTypesFile(routes: RouteInfo[]): string {
    // Use Map to handle route deduplication (user routes override default routes)
    const routeMap = new Map<string, string>();

    // First, add default Medusa routes
    for (const [route, importType] of Object.entries(defaultMedusaRoutes)) {
        routeMap.set(route, importType);
    }

    // Then, override with user's custom routes (user takes priority)
    for (const route of routes) {
        const importPath = generateImportPath(route.filePath);
        routeMap.set(route.route, `typeof import("${importPath}")`);
    }

    // Generate output
    const routeEntries: string[] = [];

    for (const [route, importType] of routeMap) {
        routeEntries.push(`    "${route}": ${importType};`);
    }

    const routeEntriesContent = routeEntries.join("\n");

    return `// This file is generated automatically by Mercur CLI
// Do not edit this file manually

export type Routes = {
${routeEntriesContent}
};
`;
}

export async function writeRouteTypes(rootDir: string) {
    const entryFilePath = path.join(rootDir, DIST_DIR, "index.ts");
    const apiDir = path.join(rootDir, "src", "api");
    const entryDir = path.dirname(entryFilePath);

    await ensureDir(entryDir);

    const routes = await getRoutes(apiDir);
    const routeTypes = generateRouteTypesFile(routes);

    await fs.writeFile(entryFilePath, routeTypes, "utf-8");
}
